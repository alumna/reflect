"use strict";var e=require("fs"),t=require("util");const i=t.promisify(e.copyFile),r=t.promisify(e.mkdir),s=t.promisify(e.readdir),a=t.promisify(e.rmdir),c=t.promisify(e.stat),h=t.promisify(e.unlink),n=t.promisify(e.utimes);class d{constructor(e,t){this.cache={},this.exclude={},this.recursive=e,this.delete=t}async start(e,t,i){return e&&t?"string"!=typeof e||"string"!=typeof t?{res:!1,err:"Parameters 'src' and 'dest' must be string paths"}:(e=this.fix(e),t=this.fix(t),await this.prepare(e,"src")&&await this.prepare(t,"dest")?(i.forEach(t=>this.exclude[e+"/"+t]=!0),await this.walk(e,t),{res:'Directory "'+e+'" reflected to "'+t+'"',err:!1}):{res:!1,err:"Parameters 'src' and 'dest' must be a directory"}):{res:!1,err:"Parameters 'src' and 'dest' must be defined"}}async prepare(e,t){return!!await this.is_dir(e)||!await this.read(e)&&("src"!=t&&(this.cache[e]=!0,await r(e),!0))}async walk(e,t){const i=[],r=await s(e),a=await s(t);if(this.delete&&a.length){const e={};r.forEach(t=>e[t]=!0);a.filter(i=>!e[i]&&!this.exclude[t+"/"+i]).forEach(e=>i.push(this.remove(t+"/"+e)))}return r.forEach(r=>i.push(this.sync(e+"/"+r,t+"/"+r))),Promise.all(i)}async sync(e,t){return!!this.exclude[e]||(await this.is_dir(e)?!this.recursive||(await this.prepare(t,"dest"),this.walk(e,t)):!(!await this.read(t)||this.is_different(e,t))||(await i(e,t),n(t,this.cache[e].atime,this.cache[e].mtime)))}async read(e){if(void 0===this.cache[e])try{return this.cache[e]=await c(e)}catch(t){return this.cache[e]=!1,!1}return this.cache[e]}async remove(e){if(!await this.is_dir(e))return this.cache[e]=!1,h(e);const t=await s(e);return await Promise.all(t.map(t=>this.remove(e+"/"+t))),this.cache[e]=!1,a(e)}async is_dir(e){return!!await this.read(e)&&this.cache[e].isDirectory()}is_different(e,t){return this.cache[e].size!=this.cache[t].size||this.cache[e].mtime.getTime()!=this.cache[t].mtime.getTime()}fix(e){const t=e.slice(-1);return"/"==t||"\\"==t?e.slice(0,-1):e}}module.exports=function({src:e,dest:t,recursive:i=!0,delete:r=!0,exclude:s=[]}){return new d(i,r).start(e,t,s)};
